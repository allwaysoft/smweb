<include file="Public:head"/><include file="Public:navbar_admin"/>
<script type="text/javascript" src="<{:RES}>/public/js/bootstrap-datetimepicker/bootstrap-datetimepicker.js"></script>
<script type="text/javascript" src="<{:RES}>/public/js/bootstrap-datetimepicker/bootstrap-datetimepicker.zh-CN.js"></script>
<link href="<{:RES}>/public/js/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css" rel="stylesheet">
<!--  container  -->

<div class="container"> 
<div id="msgShow"></div>
<div class="row">
    
  <!-- top ----->
    <div class="col-xs-12">
       <h1><i class="fa fa-bell-o" aria-hidden="true"></i> 质量投诉记录</h1>
      <div class="h20"></div>
      <ul class="nav nav-pills searchTop" role="tablist">
        <li 
        
        <if condition="ACTION_NAME eq 'quality'"> class='active' </if>
        > <a href="<{:U('service/quality')}>"><i class="fa fa-bell-o" aria-hidden="true"></i> 质量投诉</a>
        </li>
        <li 
        
        <if condition="ACTION_NAME eq 'index'"> class='active' </if>
        ><a href="<{:U('service/index')}>"><span class="glyphicon glyphicon-eye-open"></span> 服务投诉</a>
        </li>
      
        <li 
        
        <if condition="ACTION_NAME eq 'terminal'"> class='active' </if>
        > <a href="<{:U('service/terminal')}>"><i class="fa fa-lightbulb-o" aria-hidden="true"></i> 终端抽检</a>
        </li>
      </ul>
      <hr />
      <form class="form-inline" role="form" name="searcForm" id="searcForm">
        <div class="form-group form-group-sm">
          <label for="agent_area">区域：</label>
          <select name="agent_area" id="agent_area" class="form-control">
            <option value="">全部区域</option>
            <volist name="arealist" id="vo">
              <option value="<{$vo.areaname}>"><{$vo.areaname}></option>
            </volist>
          </select>
        </div>
       
        <div class="form-group form-group-sm">
          <label for="com_type" class=" ">&nbsp;&nbsp;&nbsp;&nbsp;投诉类型：</label>
          <select name="com_type" id="com_type" class="form-control">
            <option value="">全部</option>
            <option value="1">图片鉴定</option>
            <option value="2">实物鉴定</option>  
          </select>
          
        </div>
        <!-- item -->
         <div class="form-group form-group-sm">
          <label for="tra_type" class=" ">&nbsp;&nbsp;&nbsp;&nbsp;鉴定结果：</label>
          <select name="tra_type" id="tra_type" class="form-control">
            <option value="">全部</option>
            <option value="1">拒收/驳回</option>
            <option value="2">启动OA流程</option> 
            <option value="5">投诉处理结束</option>
          </select>
          
        </div>
        <!-- item -->
        <div class="form-group form-group-sm">
        <label for="inputEmail3" class=" ">&nbsp;&nbsp;&nbsp;&nbsp;投诉日期：</label>
          
          <div class="input-group">
               <div class="input-group date form_date" data-date="" data-date-format="yyyy-mm-dd" data-link-field="reg_start_time" data-link-format="yyyy-mm-dd">
                 
                  <input type="text" class="form-control" size="12" name="start_time"  id="start_time" placeholder="" value="">
                     <span class="input-group-addon"><span class="glyphicon glyphicon-remove "></span></span> 
                   <span class="input-group-addon"> <span class="glyphicon glyphicon-calendar"></span></span> 
                  </div>
          </div>
        </div>
        <!-- item -->
         <!-- item -->
        <div class="form-group form-group-sm">
        <label for="inputEmail3" class=" ">~</label>
          
          <div class="input-group">
               <div class="input-group date form_date" data-date="" data-date-format="yyyy-mm-dd" data-link-field="reg_start_time" data-link-format="yyyy-mm-dd">
                 
                  <input type="text" class="form-control" size="12" name="end_time"  id="end_time" placeholder="" value="">
                     <span class="input-group-addon"><span class="glyphicon glyphicon-remove "></span></span> 
                   <span class="input-group-addon"> <span class="glyphicon glyphicon-calendar"></span></span> 
                  </div>
          </div>
        </div>
        <!-- item -->
        <div class="clearfix h20"></div>
        
         <!-- item -->
        <div class="form-group form-group-sm">
        <label for="keyword" class=" ">关键字：</label>
        <input type="text" class="form-control" size="50" name="keyword"  id="keyword" placeholder="如店面名称、联系人、投诉内容" value="">
       
        </div>
        <!-- item -->
        
        <div class="form-group  form-group-sm">
           <button type="button" class="btn btn-info btn-sm" name="search"><i class="fa fa-search" aria-hidden="true"></i> 搜索</button>
          <div class="input-group" style="margin-left:30px;">
          <label >导出区间（默认当月）：</label>
               <div class="input-group date form_date" data-date="" data-date-format="yyyy-mm-dd" data-link-format="yyyy-mm-dd">
                 
                  <input type="text" class="form-control" size="12" name="e_start_time"  id="e_start_time" placeholder="" value="" onchange="changeEndTime();">
                     <span class="input-group-addon"><span class="glyphicon glyphicon-remove "></span></span> 
                     <span class="input-group-addon"> <span class="glyphicon glyphicon-calendar"></span></span> 
                  </div>
          </div>
           <label for="inputEmail3" class=" ">~</label>
          <div class="input-group">
               <div class="input-group "" >
                 
                  <input type="text" class="form-control" size="12" name="e_end_time"  id="e_end_time" placeholder="" value=""  readonly="readonly">
                   <span class="input-group-addon"> <span class="glyphicon glyphicon-calendar" ></span></span> 
                  </div>
          </div>
           <button  type="button" class="btn btn-success btn-sm" name="outExcel"><i class="fa fa-file-excel-o" aria-hidden="true"></i> 导出</button>
        </div>
        

      </form>
      <hr />
      <!-- top ----->
      </div>
  <!-- main ----->
  
    <div class="col-xs-12"> 
      <form action="" method=" ">
        <table  id="listTable" class="table table-striped table-bordered "  cellspacing="0" width="100%">
          <thead>
            <tr>
               <th>投诉编号 <span class="sr-only"></span></th>
              <th>代理商账号 <span class="sr-only"></span></th>
              <th>区域 <span class="sr-only"></span></th>
              <th>联系人 <span class="sr-only"></span></th>
               <th>类型 <span class="sr-only"></span></th>
               <th>款号 <span class="sr-only"></span></th>
              <th>时间<span class="sr-only"></span></th>
              <th>状态<span class="sr-only"></span></th>
              <th>客服<span class="sr-only"></span></th>
              <th>操作<span class="sr-only"></span></th>
            </tr>
          </thead>
        </table>
      </form>
    </div>
  </div>
  <!-- main --> 
</div>
<!--  container  --> 
<script type="text/javascript">
 // JavaScript Document 
$(document).ready(function(){ 
   ////////////////////
	  $('.form_date').datetimepicker({
        language: 'zh-CN',
		 pickerPosition: "bottom-left",
        weekStart: 1,
        todayBtn: 1,
		  autoclose: 1,
		  todayHighlight: 1,
		  startView: 2,
		  minView: 2,
		  forceParse: 0
    });
	 /////load 
			   
			   /////////////// 

  $("button[name='search']").click(function() { 
 $('#listTable').dataTable().fnDestroy(); 
 var table = $('#listTable').dataTable( { 
				      "processing": true,
				 	  "serverSide": false,
					  "fixedHeader": true,
					   "responsive": true,
					 "ajax":{
						  "url": "/semir400admin.php/Service/quality_get_list/source/quality",
					  },
					 "order": [[ 0, "desc" ]],
					 "columns": [
							{"data": "com_code"},
							{ "data": "agent_code" },
							{ "data": "agent_area" },
							{ "data": "agent_person" },
							{ "data": "com_type" },
							{ "data": "style_id" },
							{ "data": "add_time" },
							{ "data": "com_status" },
							{ "data": "com_user" },
							{ "data": null, "order":false}
						],
						"language": {
						 "lengthMenu": "每页 _MENU_ 条记录",
						 "zeroRecords": "没有找到记录",
						 "info": " 记录_MAX_ 条,  第 _PAGE_ 页 ( 总共 _PAGES_ 页 )",
						 "infoEmpty": "无记录",
						 "infoFiltered": "(从 _MAX_ 条记录过滤)",
						 "sSearch": "搜索:", 
						 "sEmptyTable": "表中数据为空",
						 "sLoadingRecords": "载入中...",
						 "sInfoThousands": ",",
						 "oPaginate": {
							   "sFirst": "首页",
							   "sPrevious": "上页",
							   "sNext": "下页",
							   "sLast": "末页"
						   }
						},  
					"fnRowCallback":function(nRow,aData,iDataIndex){
						//$('td:eq(0)',nRow).addClass("tableDate");
						var html = "";
						 
						 html +="<a class='btn btn-success btn-xs'  onclick=_getinfo('"+aData.id+"')><i class='fa fa-flash' aria-hidden='true'></i> 详情</a>";
						 
							$('td:eq(-1)',nRow).html(html); 
						//return nRow;
					},
          		 "deferRender": true,
				  // reload 带搜索参数
				 "fnServerParams" : function (aoData) {
                    aoData.push(
                        {  "name": "agent_area", "value": $("#agent_area").val()}
                    ); 
					 aoData.push(
                        {  "name": "tra_type", "value": $("#tra_type").val()}
                    );
					 aoData.push(
                        {  "name": "start_time", "value": $("#start_time").val()}
                    );
					 aoData.push(
                        {  "name": "end_time", "value": $("#end_time").val()}
                    ); 
					 aoData.push(
                        {  "name": "keyword", "value": $("#keyword").val()}
                    ); 
					 aoData.push(
                        {  "name": "com_type", "value": $("#com_type").val()}
                    ); 
                },
			   });
 	// table.fnDraw();
//  	  table.api().ajax.reload();
 	 //table.fnReloadAjax();
   });
	 /////////////// 
  $("button[name='outExcel']").click(function() { 
  		var post_data = $("#searcForm").serialize();  
 	    window.location.href = "<{:U('service/quality_excel')}>?"+post_data; //转到另一页面
   }); 
	   /////////////// 
});
/////////////////////////
 
 //	
  /////edit  
	function _getinfo(id){  
		BootstrapDialog.show({
			size: BootstrapDialog.SIZE_WIDE,
            title: '投诉详情',
			closeByBackdrop: false,
			buttons: [  
					{
						label: '关闭',
						cssClass: ' btn-default btn-sm',
						action: function(dialogItself){
							dialogItself.close();
						}
					}],
            message: $('<div></div>').load("/semir400admin.php/Service/qualityinfo/id/"+id) 
        });
	};
 //	 
function changeEndTime(){
  var  e_stime = $('#e_start_time').val();
  var r = new RegExp('-','gi');
   if(e_stime=='' || e_stime.match(r).length != 2){
	   $('#e_end_time').val('');
	   alert("请输入正确的时间，否则只导出最近一个月的记录。");
   }
   else{
	  var date_str = e_stime.split('-');	 
       mon = 1  + parseInt(date_str[1]);
	  if(mon < 10){
	     $('#e_end_time').val(date_str[0] + '-0' + mon + '-' + date_str[2]);	 
	  }
	  else if(mon > 12){
		  mon = mon -12;
		  date_str[0] = parseInt(date_str[0])+1;
		  $('#e_end_time').val(date_str[0] + '-' + mon + '-' + date_str[2]);	 
	  }else		  
		  $('#e_end_time').val(date_str[0] + '-' + mon + '-' + date_str[2]);	 
		  
   }
 }
 
</script> 
<include file="Public:foot"/>